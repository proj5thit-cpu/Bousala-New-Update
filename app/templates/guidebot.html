{% extends "base.html" %}
{% block content %}

<!-- ===============================
   GuideBot Header
================================== -->
<section class="guidebot-header text-center py-5">
  <div class="container">
    <h2 class="fw-bold mb-3 page-title">
      {% if lang == 'en' %}
        ğŸ¤– GuideBot â€“ Your Supportive Companion
      {% else %}
        ğŸ¤– Ø¯Ù„ÙŠÙ„ Ø¨ÙˆØª â€“ Ø±ÙÙŠÙ‚Ùƒ Ø§Ù„Ø¯Ø§Ø¹Ù…
      {% endif %}
    </h2>

    <p class="lead mb-0 page-subtitle">
      {% if lang == 'en' %}
        Your assistant for awareness, emotional support, and smart decision-making during crises.
      {% else %}
        Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ù„Ù„ØªÙˆØ¹ÙŠØ©ØŒ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†ÙØ³ÙŠØŒ ÙˆØ§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ø­ÙƒÙŠÙ…Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø£Ø²Ù…Ø§Øª.
      {% endif %}
    </p>
  </div>
</section>

<!-- ============================================================
   CHAT WRAPPER
=============================================================== -->
<section class="container my-5">
  <div class="chatbot-wrapper shadow-lg rounded-4" id="chat-wrapper">
    <div id="chat-box" class="chat-box"></div>
    <div id="option-area" class="option-area"></div>
  </div>
</section>

<!-- ============================================================
   STYLES
=============================================================== -->
<style>

/* ---------------------------------
   Global Page Styling
---------------------------------- */
body {
  background: linear-gradient(160deg, #fff7ef, #ffe4cc, #ffd2a1);
  background-attachment: fixed;
  font-family: 'Cairo', 'Inter', sans-serif;
}

.page-title {
  color:#5a2800;
  font-size: 2.5rem;
}

.page-subtitle {
  font-size: 1.15rem;
  max-width: 850px;
  margin: auto;
  color: #5c3c1e;
}

.guidebot-header {
  background: linear-gradient(135deg, #ffe6cc, #ffcf99, #ffb56b);
  color: #4b2f15;
  border-bottom: 4px solid #e0a36e;
}



/* ---------------------------------
   Chat Container
---------------------------------- */
.chatbot-wrapper {
  background: #ffffffee;
  border: 2px solid #f7d8b9;
  max-width: 780px;
  margin: auto;
  display: flex;
  flex-direction: column;
  border-radius: 24px;
  overflow: hidden;
  backdrop-filter: blur(3px);
}

.chat-box {
  height: 550px;
  overflow-y: auto;
  padding: 25px 22px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: rgba(255, 245, 232, 0.7);
  scroll-behavior: smooth;
}

.option-area {
  background: #fff8f1;
  padding: 15px 18px;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
  border-top: 2px solid #f3d4b1;
}

/* ---------------------------------
   Chat Bubbles
---------------------------------- */

.message-bubble {
  max-width: 88%;
  padding: 14px 20px;
  border-radius: 20px;
  font-size: 1.12rem;
  line-height: 1.55;
  word-wrap: break-word;
  background: #eee;
  box-shadow: 0px 2px 6px rgba(0,0,0,0.08);
  animation: fadeIn 0.25s ease-in-out;
}

/* Bot bubble */
.bot-message { 
  align-self: flex-start; 
}

.bot-message .message-bubble {
  background: #f3e8d9;
  border-bottom-left-radius: 5px;
  color: #3a2c20;
}

/* User bubble */
.user-message { 
  align-self: flex-end; 
  text-align: right;
}

.user-message .message-bubble {
  background: linear-gradient(120deg, #ff9f53, #e27a1f);
  color: white;
  border-bottom-right-radius: 5px;
  font-weight: 500;
  letter-spacing: 0.3px;
}



/* ---------------------------------
   Typing Dots Effect
---------------------------------- */
.typing span {
  display: inline-block;
  width: 7px;
  height: 7px;
  margin: 0 2px;
  background-color: #8a847c;
  border-radius: 50%;
  opacity: 0.5;
  animation: blink 1.5s infinite ease-in-out;
}

.typing span:nth-child(2) { animation-delay: 0.2s; }
.typing span:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
  0%, 80%, 100% { opacity: 0.4; transform: scale(1); }
  40% { opacity: 1; transform: scale(1.35); }
}



/* ---------------------------------
   Buttons
---------------------------------- */
.btn-option {
  background: linear-gradient(135deg, #e38829, #cc6a11);
  color: #fff;
  border: none;
  border-radius: 26px;
  padding: 11px 22px;
  font-size: 1.05rem;
  font-weight: 500;
  cursor: pointer;
  transition: 0.25s ease;
  box-shadow: 0px 3px 6px rgba(180, 100, 20, 0.25);
}

.btn-option:hover {
  background: linear-gradient(135deg, #cc6a11, #a9550c);
  transform: translateY(-2px);
}



/* ---------------------------------
   RTL Support
---------------------------------- */
[dir="rtl"] .chat-box,
[dir="rtl"] .option-area {
  text-align: right;
}

[dir="rtl"] .bot-message .message-bubble {
  border-bottom-right-radius: 5px; 
  border-bottom-left-radius: 20px;
}

[dir="rtl"] .user-message .message-bubble {
  border-bottom-left-radius: 5px;
  border-bottom-right-radius: 20px;
}



/* Smooth fade animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

</style>

<!-- ===============================
   Chatbot Script
================================== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const chatBox = document.getElementById('chat-box');
  const optionArea = document.getElementById('option-area');
  let currentLang = 'en';

  function addMessage(text, sender = 'bot', delay = true) {
    if (sender === 'bot' && delay) {
      const typing = document.createElement('div');
      typing.className = 'bot-message';
      typing.innerHTML = `<div class="message-bubble"><div class="typing"><span></span><span></span><span></span></div></div>`;
      chatBox.appendChild(typing);
      chatBox.scrollTop = chatBox.scrollHeight;
      setTimeout(() => {
        typing.remove();
        actuallyAdd(text, sender);
      }, 1000);
    } else {
      actuallyAdd(text, sender);
    }
  }

  function actuallyAdd(text, sender) {
    const msg = document.createElement('div');
    msg.className = `${sender}-message`;
    msg.innerHTML = `<div class="message-bubble">${text}</div>`;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function setButtons(buttons) {
    optionArea.innerHTML = '';
    buttons.forEach(b => {
      const btn = document.createElement('button');
      btn.className = 'btn-option';
      btn.textContent = b.label;
      btn.onclick = () => {
        addMessage(b.label, 'user', false);
        optionArea.innerHTML = '';
        setTimeout(b.action, 600);
      };
      optionArea.appendChild(btn);
    });
  }

  function restart() {
    optionArea.innerHTML = '';
    chatBox.innerHTML = '';
    startConversation();
  }

  function startConversation() {
    addMessage("ğŸ‘‹ Hello! I'm GuideBot, here to assist you with awareness, mental health, and decision-making during conflict.");
    addMessage("Please choose your language to continue:");
    setButtons([
      { label: 'English', action: () => chooseLanguage('en') },
      { label: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', action: () => chooseLanguage('ar') }
    ]);
  }

  function chooseLanguage(lang) {
    currentLang = lang;
    document.documentElement.dir = (lang === 'ar' ? 'rtl' : 'ltr');
    chatBox.innerHTML = '';
    addMessage(
      lang === 'en'
        ? "Great! Please choose one of the following areas I can help you with:"
        : "Ø±Ø§Ø¦Ø¹! Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø°ÙŠ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠÙ‡:"
    );
    setButtons([
      { label: (lang === 'en' ? 'ğŸ§  Awareness About Misinformation' : 'ğŸ§  Ø§Ù„ØªÙˆØ¹ÙŠØ© Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¶Ù„Ù„Ø©'), action: () => (lang === 'en' ? awarenessFlow() : awarenessFlowAr()) },
      { label: (lang === 'en' ? 'ğŸ’¬ Mental / Psychological Support' : 'ğŸ’¬ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†ÙØ³ÙŠ / Ø§Ù„Ù…Ø¹Ù†ÙˆÙŠ'), action: () => (lang === 'en' ? mentalFlow() : mentalFlowAr()) },
      { label: (lang === 'en' ? 'ğŸ•Šï¸ Support Decision-Making' : 'ğŸ•Šï¸ Ø¯Ø¹Ù… Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±'), action: () => (lang === 'en' ? decisionFlow() : decisionFlowAr()) }
    ]);
  }

  /** ===== ENGLISH FLOWS ===== **/

  function awarenessFlow() {
    addMessage("â“ What is misinformation?");
    addMessage("Misinformation means any false or inaccurate content shared intentionally or not, leading people to misunderstand something. It spreads fast during crises because it triggers emotions and is easy to share without verification.");
    setButtons([
      { label: 'ğŸ“˜ Learn about types', action: () => { window.open("{{ url_for('main.misinfo_type', lang='en') }}", "_blank"); setButtons([{ label: 'Next â¡ï¸', action: awarenessNext }, { label: 'Start Over ğŸ”„', action: restart }]); } }
    ]);
  }

  function awarenessNext() {
    addMessage("Did you face misinformation before?");
    setButtons([
      { label: 'Yes', action: facedYes },
      { label: 'No', action: facedNo }
    ]);
  }

  function facedYes() {
    addMessage("You can share your story here:");
    setButtons([
      { label: 'ğŸ“ Share Story', action: () => { window.open("{{ url_for('main.post', lang='en') }}", "_blank"); setButtons([{ label: 'Start Over ğŸ”„', action: restart }]); } },
      { label: 'Start Over ğŸ”„', action: restart }
    ]);
  }

  function facedNo() {
    addMessage("You can see what Sudanese journalists write about this.");
    setButtons([
      { label: 'View Articles', action: showArticles },
      { label: 'Start Over ğŸ”„', action: restart }
    ]);
  }

  function showArticles() {
    addMessage(`<a href="https://www.khmstashr.com/index.php?page=guideline&guideline_id=6" target="_blank">ğŸ“° Article 1</a>`);
    addMessage(`<a href="https://wasl.news" target="_blank">ğŸ“° Article 2</a>`);
    setButtons([{ label: 'Start Over ğŸ”„', action: restart }]);
  }

  function mentalFlow() {
    addMessage("ğŸ’­ How can I help you?");
    setButtons([
      { label: 'Understand the mental impact of misinformation', action: () => { addMessage("Hereâ€™s some helpful advice:"); setButtons([{ label: 'ğŸŒ¿ View Advice', action: () => { window.open("{{ url_for('main.advices', lang='en') }}", "_blank"); setButtons([{ label: 'Start Over ğŸ”„', action: restart }]); } }, { label: 'Start Over ğŸ”„', action: restart }]); } },
      { label: 'Therapist Contact Numbers', action: therapistFlow }
    ]);
  }

  function therapistFlow() {
    addMessage("Would you like to:");
    setButtons([
      { label: 'ğŸ¥ Visit Clinics (Egypt / KSA)', action: clinicFlow },
      { label: 'ğŸ’» Remote Communication', action: remoteFlow }
    ]);
  }

  function clinicFlow() {
    addMessage("Choose a location:");
    setButtons([
      { label: 'ğŸ‡ªğŸ‡¬ Egypt', action: () => { addMessage("Clinics in Egypt: Mirsah Clinic +20 111 2323330<br>Psy Care Clinic +20 120 7799988"); setButtons([{ label: 'Start Over ğŸ”„', action: restart }]); } },
      { label: 'ğŸ‡¸ğŸ‡¦ KSA', action: () => { addMessage("Medicare Clinic Riyadh 9200 05531<br>Al Amal Complex Madinah 014 861 9200<br>Tamaneenah Medical Center Jeddah 053 521 2685"); setButtons([{ label: 'Start Over ğŸ”„', action: restart }]); } }
    ]);
  }

  function remoteFlow() {
    addMessage("Online therapists: Tamaneenah +249 90 660 7664");
    setButtons([{ label: 'Start Over ğŸ”„', action: restart }]);
  }

  /** === English Decision-Making Flow === **/

  function decisionFlow() {
    addMessage("ğŸ•Šï¸ Let's support your decision-making during the conflict.");
    setButtons([
      { label: '1ï¸âƒ£ Movement & Safe Routes', action: safeRoutesFlow },
      { label: '2ï¸âƒ£ Available Hospitals', action: hospitalsFlow },
      { label: '3ï¸âƒ£ Humanitarian Supply Points', action: humanitarianFlow },
      { label: '4ï¸âƒ£ Medical Supply Points', action: medicalFlow }
    ]);
  }

  function safeRoutesFlow() {
    addMessage("Do you want instructions to facilitate your movement inside conflict areas, or see what others did before?");
    setButtons([
      { label: 'ğŸ§­ Show Instructions', action: () => { window.open("{{ url_for('main.safe_routes', lang='en') }}", "_blank"); setButtons([{ label: 'Start Over ğŸ”„', action: restart }]); } },
      { label: 'ğŸ“– See Othersâ€™ Stories', action: () => fetchAndShowStories('safe_routes') }
    ]);
  }

  function hospitalsFlow() {
    addMessage("Do you want names and numbers of hospitals, or see what others did before?");
    setButtons([
      { label: 'ğŸ¥ Get Hospital Info', action: () => {
          addMessage("Here are some hospitals currently receiving patients:");
          addMessage("1. Al-Salama Hospital â€“ +249 912 345 678<br>2. Omdurman Medical Center â€“ +249 911 222 333");
          setButtons([{ label: 'Start Over ğŸ”„', action: restart }]);
        }
      },
      { label: 'ğŸ“– See Othersâ€™ Stories', action: () => fetchAndShowStories('hospitals') }
    ]);
  }

  function humanitarianFlow() {
    addMessage("Do you want steps to check if thereâ€™s a distribution point in your area, or see what others did before?");
    setButtons([
      { label: 'ğŸ“ Check Distribution Steps', action: () => { window.open("{{ url_for('main.advices', lang='en') }}", "_blank"); setButtons([{ label: 'Start Over ğŸ”„', action: restart }]); } },
      { label: 'ğŸ“– See Othersâ€™ Stories', action: () => fetchAndShowStories('humanitarian') }
    ]);
  }

  function medicalFlow() {
    addMessage("Do you want steps to check the place, or see what others did before?");
    setButtons([
      { label: 'ğŸ’Š Provide Pharmacist Contacts', action: () => {
          addMessage("I can support you with pharmacist numbers who deliver medicines to your home. Do you want this service?");
          setButtons([
            { label: 'Yes', action: showPharmacists },
            { label: 'No', action: restart }
          ]);
        }
      },
      { label: 'ğŸ“– See Othersâ€™ Stories', action: () => fetchAndShowStories('medical') }
    ]);
  }

  function showPharmacists() {
    addMessage("This service is available in Khartoum, Omdurman, and Bahri:");
    addMessage("â€¢ Ø£Ù…Ø¯Ø±Ù…Ø§Ù†: ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ù†Ø¹Ù…Ø§Ù† â€” 0123166441<br>â€¢ ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù…Ø¹Ø² â€” 01282823737<br>â€¢ Ø§Ù„Ø®Ø±Ø·ÙˆÙ…: ØµÙŠØ¯Ù„ÙŠØ© Ù…Ø±ØªØ¶Ù‰ Ø§Ù„Ù‡Ø§Ø¯ÙŠ â€” 0917485000<br>â€¢ Ø¨Ø­Ø±ÙŠ: ØµÙŠØ¯Ù„ÙŠØ© Ù†Ù‡Ù‰ â€” 0965020683<br>â€¢ Ø´Ø±ÙƒØ© Ø¯ÙˆØ§Ø¦ÙŠ ØªÙˆØµÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø®Ø±Ø·ÙˆÙ… â€” 0912341665<br>Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø¯ÙˆØ§Ø¡ Ù…Ø¹ÙŠÙ† Ø£Ùˆ Ù…Ù†Ø·Ù‚Ø© Ù…Ø¹ÙŠÙ†Ø©: <a href='https://t.me/wafradawaa' target='_blank'>Telegram</a>");
    setButtons([{ label: 'Start Over ğŸ”„', action: restart }]);
  }

  function fetchAndShowStories(type) {
    addMessage("Fetching stories â€¦");
    fetch(`/get_stories/${encodeURIComponent(type)}`)
      .then(resp => resp.json())
      .then(data => {
        if (data && data.length > 0) {
          data.forEach(story => {
            addMessage(`ğŸ—£ï¸ ${story.content}`);
          });
        } else {
          addMessage("No stories found yet for this topic.");
        }
        addMessage("Do you want to see more stories about other topics?");
        setButtons([
          { label: 'Yes', action: () => { window.open("{{ url_for('main.posts_list', lang='en') }}", "_blank"); } },
          { label: 'No, Start Over ğŸ”„', action: restart }
        ]);
      })
      .catch(err => {
        console.error(err);
        addMessage("âš ï¸ Failed to load stories. Try again later.");
        setButtons([{ label: 'Start Over ğŸ”„', action: restart }]);
      });
  }

  /** ===== ARABIC FLOWS ===== **/

  function awarenessFlowAr() {
    addMessage("â“ Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¶Ù„Ù„Ø©ØŸ");
    addMessage("Ù‡ÙŠ Ø£ÙŠ Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚ Ø£Ùˆ Ø®Ø§Ø·Ø¦ ÙŠØªÙ… Ù†Ø´Ø±Ù‡ Ø³ÙˆØ§Ø¡ Ø¹Ù† Ù‚ØµØ¯ Ø£Ùˆ Ø¨Ø¯ÙˆÙ† Ù‚ØµØ¯ØŒ Ù…Ù…Ø§ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø³ÙˆØ¡ ÙÙ‡Ù…. ØªÙ†ØªØ´Ø± Ø¨Ø³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„Ø£Ø²Ù…Ø§Øª Ù„Ø£Ù†Ù‡Ø§ ØªØ«ÙŠØ± Ø§Ù„Ø¹ÙˆØ§Ø·Ù.");
    setButtons([
      { label: 'ğŸ“˜ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¶Ù„Ù„Ø©', action: () => { window.open("{{ url_for('main.misinfo_type', lang='ar') }}", "_blank"); setButtons([{ label: 'Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸', action: awarenessNextAr }, { label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]); } }
    ]);
  }

  function awarenessNextAr() {
    addMessage("Ù‡Ù„ ÙˆØ§Ø¬Ù‡Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø¶Ù„Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„ØŸ");
    setButtons([{ label: 'Ù†Ø¹Ù…', action: facedYesAr }, { label: 'Ù„Ø§', action: facedNoAr }]);
  }

  function facedYesAr() {
    addMessage("ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø´Ø§Ø±ÙƒØ© Ù‚ØµØªÙƒ Ù‡Ù†Ø§:");
    setButtons([{ label: 'ğŸ“ Ø´Ø§Ø±Ùƒ Ù‚ØµØªÙƒ', action: () => { window.open("{{ url_for('main.post', lang='ar') }}", "_blank"); setButtons([{ label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]); } }]);
  }

  function facedNoAr() {
    addMessage("ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ù…Ø§ ÙŠÙƒØªØ¨Ù‡ Ø§Ù„ØµØ­ÙÙŠÙˆÙ† Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠÙˆÙ†:");
    setButtons([{ label: 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª', action: showArticlesAr }, { label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]);
  }

  function showArticlesAr() {
    addMessage(`<a href="https://www.khmstashr.com/index.php?page=guideline&guideline_id=6" target="_blank">ğŸ“° Ø§Ù„Ù…Ù‚Ø§Ù„ Ù¡</a>`);
    addMessage(`<a href="https://wasl.news" target="_blank">ğŸ“° Ø§Ù„Ù…Ù‚Ø§Ù„ Ù¢</a>`);
    setButtons([{ label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]);
  }

  function mentalFlowAr() {
    addMessage("ğŸ’­ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ");
    setButtons([
      { label: 'ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¶Ù„Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙØ³', action: () => { addMessage("Ø¥Ù„ÙŠÙƒ Ø¨Ø¹Ø¶ Ø§Ù„Ù†ØµØ§Ø¦Ø­:"); setButtons([{ label: 'ğŸŒ¿ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØµØ§Ø¦Ø­', action: () => { window.open("{{ url_for('main.advices', lang='ar') }}", "_blank"); setButtons([{ label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]); } }, { label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]); } },
      { label: 'Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ÙŠÙ†', action: therapistFlowAr }
    ]);
  }

  function therapistFlowAr() {
    addMessage("Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ:");
    setButtons([
      { label: 'ğŸ¥ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª (Ù…ØµØ± / Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©)', action: clinicFlowAr },
      { label: 'ğŸ’» Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ù† Ø¨Ø¹Ø¯', action: remoteFlowAr }
    ]);
  }

  function clinicFlowAr() {
    addMessage("Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©:");
    setButtons([
      { label: 'ğŸ‡ªğŸ‡¬ Ù…ØµØ±', action: () => { addMessage("Ø¹ÙŠØ§Ø¯Ø© Ù…Ø±Ø³Ø§Ø©: +20 111 2323330<br>Ø³Ø§ÙŠ ÙƒÙŠØ±: +20 120 7799988"); setButtons([{ label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]); } },
      { label: 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', action: () => { addMessage("Ù…ÙŠØ¯ÙŠ ÙƒÙŠØ± Ø§Ù„Ø±ÙŠØ§Ø¶: 9200 05531<br>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø£Ù…Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: 014 861 9200<br>Ù…Ø·Ù…Ø¦Ù†Ø© Ø¬Ø¯Ø©: 053 521 2685"); setButtons([{ label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]); } }
    ]);
  }

  function remoteFlowAr() {
    addMessage("Ø·Ù…Ø£Ù†ÙŠÙ†Ø© Ù„Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ù†ÙØ³ÙŠØ© Ø¹Ù† Ø¨Ø¹Ø¯ +249 90 660 7664");
    setButtons([{ label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]);
  }

  /** === Arabic Decision-Making Flow === **/

  function decisionFlowAr() {
    addMessage("ğŸ•Šï¸ Ø¯Ø¹Ù†Ø§ Ù†Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø²Ø§Ø¹.");
    setButtons([
      { label: '1ï¸âƒ£ Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¢Ù…Ù†Ø©', action: safeRoutesFlowAr },
      { label: '2ï¸âƒ£ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©', action: hospitalsFlowAr },
      { label: '3ï¸âƒ£ Ù†Ù‚Ø§Ø· ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª', action: humanitarianFlowAr },
      { label: '4ï¸âƒ£ Ù†Ù‚Ø§Ø· ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©', action: medicalFlowAr }
    ]);
  }

  function safeRoutesFlowAr() {
    addMessage("Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„ØªØ³Ù‡ÙŠÙ„ Ø­Ø±ÙƒØªÙƒ Ø¯Ø§Ø®Ù„ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù†Ø²Ø§Ø¹ØŒ Ø£Ù… Ù…Ø¹Ø±ÙØ© Ù…Ø§ ÙØ¹Ù„Ù‡ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†ØŸ");
    setButtons([
      { label: 'ğŸ“ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø­Ø±ÙƒØ©', action: () => { window.open("{{ url_for('main.safe_routes', lang='ar') }}", "_blank"); setButtons([{ label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]); } },
      { label: 'ğŸ“– Ù…Ø§ ÙØ¹Ù„Ù‡ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†', action: () => fetchAndShowStories('safe_routes') }
    ]);
  }

  function hospitalsFlowAr() {
    addMessage("Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ù…Ø¹Ø±ÙØ© Ø£Ø³Ù…Ø§Ø¡ ÙˆØ£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ø£Ù… Ù…Ø¹Ø±ÙØ© Ù…Ø§ ÙØ¹Ù„Ù‡ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†ØŸ");
    setButtons([
      { label: 'ğŸ¨ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ ÙˆØ£Ø±Ù‚Ø§Ù…', action: () => {
          addMessage("Ø¥Ù„ÙŠÙƒ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…Ø±Ø¶Ù‰:");
          addMessage("â€¢ Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø®Ø±Ø·ÙˆÙ… Ø§Ù„Ø¹Ø§Ù… â€” â˜ï¸ 249-183-123456<br>â€¢ Ù…Ø³ØªØ´ÙÙ‰ Ø£Ù…Ø¯Ø±Ù…Ø§Ù† â€” â˜ï¸ 249-183-654321");
          setButtons([{ label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]);
        } },
      { label: 'ğŸ“– Ù…Ø§ ÙØ¹Ù„Ù‡ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†', action: () => fetchAndShowStories('hospitals') }
    ]);
  }

  function humanitarianFlowAr() {
    addMessage("Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø®Ø·ÙˆØ§Øª Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹ ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒØŒ Ø£Ù… Ù…Ø¹Ø±ÙØ© Ù…Ø§ ÙØ¹Ù„Ù‡ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†ØŸ");
    setButtons([
      { label: 'ğŸ“¦ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹', action: () => { window.open("{{ url_for('main.advices', lang='ar') }}", "_blank"); setButtons([{ label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]); } },
      { label: 'ğŸ“– Ù…Ø§ ÙØ¹Ù„Ù‡ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†', action: () => fetchAndShowStories('humanitarian') }
    ]);
  }

  function medicalFlowAr() {
    addMessage("Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø®Ø·ÙˆØ§Øª Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ ØªÙˆØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„ÙŠÙ‡ØŒ Ø£Ù… Ù…Ø¹Ø±ÙØ© Ù…Ø§ ÙØ¹Ù„Ù‡ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†ØŸ");
    setButtons([
      { label: 'ğŸ’¬ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ­Ù‚Ù‚', action: () => {
          addMessage("ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø¯Ø¹Ù…Ùƒ Ø¨Ø£Ø±Ù‚Ø§Ù… ØµÙŠØ§Ø¯Ù„Ø© Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©. Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ");
          setButtons([
            { label: 'Ù†Ø¹Ù…', action: showPharmacistsAr },
            { label: 'Ù„Ø§', action: restart }
          ]);
        } },
      { label: 'ğŸ“– Ù…Ø§ ÙØ¹Ù„Ù‡ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†', action: () => fetchAndShowStories('medical') }
    ]);
  }

  function showPharmacistsAr() {
    addMessage("Ø§Ù„Ø®Ø¯Ù…Ø© Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ø®Ø±Ø·ÙˆÙ…ØŒ Ø£Ù…Ø¯Ø±Ù…Ø§Ù†ØŒ ÙˆØ¨Ø­Ø±ÙŠ:");
    addMessage("â€¢ Ø£Ù…Ø¯Ø±Ù…Ø§Ù†: ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ù†Ø¹Ù…Ø§Ù† â€” 0123166441<br>â€¢ ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù…Ø¹Ø² â€” 01282823737<br>â€¢ Ø§Ù„Ø®Ø±Ø·ÙˆÙ…: ØµÙŠØ¯Ù„ÙŠØ© Ù…Ø±ØªØ¶Ù‰ Ø§Ù„Ù‡Ø§Ø¯ÙŠ â€” 0917485000<br>â€¢ Ø¨Ø­Ø±ÙŠ: ØµÙŠØ¯Ù„ÙŠØ© Ù†Ù‡Ù‰ â€” 0965020683<br>â€¢ Ø´Ø±ÙƒØ© Ø¯ÙˆØ§Ø¦ÙŠ Ù„Ù„ØªÙˆØµÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ø±Ø·ÙˆÙ… â€” 0912341665<br>Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª: <a href='https://t.me/wafradawaa' target='_blank'>Telegram</a>");
    setButtons([{ label: 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]);
  }

  // Re-use this for both languages
  function fetchAndShowStories(type) {
    addMessage("â€¦");
    fetch(`/get_stories/${encodeURIComponent(type)}`)
      .then(resp => resp.json())
      .then(data => {
        if (data && data.length > 0) {
          data.forEach(s => {
            addMessage(`ğŸ—£ï¸ ${s.content}`);
          });
        } else {
          addMessage(currentLang === 'en' ? "No stories found yet for this topic." : "Ù„Ù… ØªÙØ³Ø¬Ù‘Ù„ Ù‚ØµØµ Ø¨Ø¹Ø¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….");
        }
        addMessage(currentLang === 'en'
          ? "Do you want to see more stories about other topics?"
          : "Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ù‚ØµØµ Ø­ÙˆÙ„ Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø£Ø®Ø±Ù‰ØŸ");
        setButtons([
          { label: currentLang === 'en' ? 'Yes' : 'Ù†Ø¹Ù…', action: () => window.open("{{ url_for('main.posts_list', lang=lang) }}", "_blank") },
          { label: currentLang === 'en' ? 'No, Start Over ğŸ”„' : 'Ù„Ø§ØŒ Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }
        ]);
      })
      .catch(e => {
        console.error(e);
        addMessage(currentLang === 'en' ? "Error loading stories." : "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµØµ.");
        setButtons([{ label: currentLang === 'en' ? 'Start Over ğŸ”„' : 'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ”„', action: restart }]);
      });
  }

  // Kick off
  startConversation();
});
</script>


{% endblock %}
